#!/bin/bash

echo "=== reading $(pwd)/.version file ==="
export $(cat .version | grep -v ^# | xargs)

echo "=== pulling image '${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}' ==="
docker pull ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}

echo "=== restarting service ==="
supervisorctl stop podcast-service:
# if there are some containers stay in up-state
names=$(docker ps --format "{{.Names}}" | grep podcast-)
if [ -n "$names" ]; then
    echo "stopping containers..."
    echo "$names" | xargs docker stop
    echo "containers stopped"
else
    echo "no containers to stop"
fi
echo "starting supervisorctl..."
supervisorctl start podcast-service:

echo "=== clearing ==="
echo y | docker image prune -a

echo "=== check status ==="
supervisorctl status podcast-service:

echo "=== show containers ==="
echo "sleeping for a while..."
sleep 10
docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t| {{.Ports}}\t|" | grep podcast
echo "==="

echo "=== health check ==="
app_port = 9001

health_check() {
    local url="http://localhost:${app_port}/health_check/"
    local timeout=10
    local max_retries=5
    local retry_delay=5

    for ((i=1; i<=max_retries; i++)); do
        echo "Attempt $i/$max_retries: Checking health at $url"

        # Пытаемся выполнить запрос и собираем полную информацию
        if response=$(curl -s \
                          -w "\nHTTP_STATUS:%{http_code}\nTIME_TOTAL:%{time_total}\n" \
                          --max-time "$timeout" \
                          "$url" 2>&1); then
            # Извлекаем HTTP статус
            http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d':' -f2)
            response_time=$(echo "$response" | grep "TIME_TOTAL:" | cut -d':' -f2)

            # Извлекаем тело ответа (все что до HTTP_STATUS)
            response_body=$(echo "$response" | sed '/HTTP_STATUS:/Q' | sed '$d')

            echo "Response:"
            echo "  Status: $http_status"
            echo "  Response time: ${response_time}s"
            echo "  Body: $response_body"
            echo "---"

            if [ "$http_status" = "200" ]; then
                echo "✅ Health check passed!"
                return 0
            else
                echo "❌ Health check failed with status: $http_status"
                if [ $i -lt $max_retries ]; then
                    echo "Retrying in ${retry_delay} seconds..."
                    sleep $retry_delay
                fi
            fi
        else
            curl_exit_code=$?
            echo "❌ Connection failed with exit code: $curl_exit_code"
            echo "Error output: $response"

            if [ $i -lt $max_retries ]; then
                echo "Retrying in ${retry_delay} seconds..."
                sleep $retry_delay
            fi
        fi
    done

    echo "❌ Health check failed after $max_retries attempts"
    return 1
}

# Вызываем функцию проверки здоровья
if ! health_check; then
    echo "=== Additional diagnostics ==="
    echo "Checking supervisor status:"
    supervisorctl status podcast-service:

    echo "Checking container logs:"
    docker-compose logs --tail=20

    echo "Checking port listening:"
    netstat -tlnp | grep ":$APP_PORT" || echo "Port $APP_PORT is not listening"

    exit 1
fi

echo "=== Deployment completed successfully ==="
